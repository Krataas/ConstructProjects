name: "Xây dựng EcoEnchants (Sửa lỗi Dependency)"

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: "Bước 1: Tải mã nguồn (Bao gồm Submodules)"
        uses: actions/checkout@v4
        with:
          repository: Auxilor/EcoEnchants
          submodules: 'recursive'
          fetch-depth: 0

      - name: "Bước 2: Thiết lập môi trường Java 21"
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: "Bước 3: Sửa lỗi LibreForge (Hạ cấp phiên bản)"
        # Chúng ta dùng lệnh sed để thay thế 4.80.0 bằng 4.79.0 (hoặc bản có sẵn gần nhất)
        # Lệnh này sẽ quét toàn bộ các file .gradle và .kts để sửa version bị lỗi
        run: |
          find . -type f -name "*.gradle*" -exec sed -i 's/4.80.0/4.79.0/g' {} +
          echo "Đã hạ cấp LibreForge từ 4.80.0 xuống 4.79.0 để tránh lỗi Repository."

      - name: "Bước 4: Cấp quyền và Build"
        run: |
          chmod +x gradlew
          ./gradlew assemble --no-daemon -x test

      - name: "Bước 5: Lưu trữ sản phẩm (.jar)"
        uses: actions/upload-artifact@v4
        with:
          name: EcoEnchants-Build-Fixed
          path: "**/build/libs/*.jar"
          if-no-files-found: error
